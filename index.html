<script>
fetch('data.json')
.then(res => res.json())
.then(data => {
  const tbody = document.querySelector('#videoTable tbody');
  let asc = true;

  function renderTable(sortedData){
    tbody.innerHTML = '';
    sortedData.forEach((item,index)=>{
      let nicoLink = (item["ニコニコ"] && item["ニコニコ"]!=="－") ? `<a href="https://${item["ニコニコ"]}" target="_blank">▶ニコニコ動画</a>`:"－";
      let ytLink = (item["YouTube"] && item["YouTube"]!=="－") ? `<a href="${item["YouTube"]}" target="_blank">▶YouTube</a>`:"－";
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="date">${item["投稿日"]}</td>
        <td class="song">${item["曲名"]}</td>
        <td class="nico">${nicoLink}</td>
        <td class="youtube">${ytLink}</td>
        <td class="detail"><button onclick="showDetails(${index})">詳細</button></td>
        <td style="display:none;">${item["出演者"]} ${item["本家様"]} ${item["本家制作"]} ${item["今見れる？"]} ${item["備考"]}</td>
      `;
      tbody.appendChild(tr);
    });
    updateRowColors(); // ←追加
  }


window.showDetails = function(index){
  const item = data[index];
  // 本家様がオリジナル曲・？・不明・未投稿でない場合のみリンク
  const mainLink = item["本家様"] &&
                   item["本家様"] !== "オリジナル曲" &&
                   item["本家様"] !== "？" &&
                   item["本家様"] !== "不明" &&
                   item["本家様"] !== "未投稿"
                   ? `<a href="https://${item["本家様"]}" target="_blank">${item["本家様"]}</a>`
                   : item["本家様"];
  document.getElementById('modalDetails').innerHTML = `
    <p><strong>歌唱者:</strong> ${item["出演者"]}</p>
    <p><strong>イラスト:</strong> ${item["イラスト"]}</p>
    <p><strong>創造神:</strong> ${item["本家制作"]}</p>
    <p><strong>本家様:</strong> ${mainLink}</p>
    <p><strong>今見れる？:</strong> ${item["今見れる？"]}</p>
    <p><strong>備考:</strong> ${item["備考"]}</p>
  `;
  document.getElementById('modal').style.display='block';
}

  window.onclick = function(event){
    const modal = document.getElementById('modal');
    if(event.target === modal){ modal.style.display='none'; }
  }

  renderTable(data);

  document.getElementById('searchInput').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    document.querySelectorAll('#videoTable tbody tr').forEach(row => {
      const text = row.textContent.toLowerCase();

      const searchCell = row.querySelector('td:last-child').textContent;
      const singer = searchCell;

      const isCollab = singer.includes('・');
      let combinedText = text + (isCollab ? ' コラボ' : '');

      const isOriginal = searchCell.includes('オリジナル曲');
      const isKaeshi = searchCell.includes('替え歌');
      const isMimic = searchCell.includes('声真似');
      const isCover = !isOriginal && !isKaeshi && !isMimic;
      combinedText += isCover ? ' カバー曲' : '';

      row.style.display = combinedText.includes(filter) ? '' : 'none';
    });
    updateRowColors(); // ←追加
  });

  document.getElementById('clearButton').addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchInput').dispatchEvent(new Event('input'));
  });

  document.getElementById('sortButton').addEventListener('click',()=>{
    asc = !asc;
    const sorted = data.slice().sort((a,b)=>{
      return asc ? new Date(a["投稿日"]) - new Date(b["投稿日"]) : new Date(b["投稿日"]) - new Date(a["投稿日"]);
    });
    renderTable(sorted);
  });

});
</script>
